# AI Video Generation Project - Current Context

## Project Overview
4-step AI video generation pipeline that converts text prompts into coherent video stories:
1. Text prompt analysis (Mixtral LLM)
2. Scene sequence planning (6 coherent frames) 
3. Image generation (Stable Diffusion WebUI + batch generation + face analysis)
4. Video creation with transitions (H.264 encoding)

## Current Status: ✅ FULLY FUNCTIONAL
- **Story Sequence Issue**: RESOLVED (3rd image breaking narrative flow)
- **Character Consistency**: ENHANCED (detailed character profiles + clothing analysis)
- **Clothing Consistency**: NEW (computer vision-based clothing similarity analysis)
- **Batch Generation**: ACTIVE (6 images per scene, face + clothing selection)
- **Video Output**: WORKING (H.264 encoded, browser-compatible)
- **UI Analysis Display**: ENHANCED (shows all 36 batch images with scores)

## Key Components

### Core Files
- `app.py` - Gradio web interface (port 8003)
- `video_generator.py` - Main pipeline orchestration
- `mixtral_client.py` - LLM integration for scene analysis and character consistency
- `sd_client.py` - Stable Diffusion WebUI API client with ADetailer integration
- `face_analyzer.py` - MediaPipe/OpenCV face detection, quality scoring, and clothing similarity analysis
- `face_selector.py` - Random face selection from in/individual/ directory for Roop face swapping

### Current Configuration
- **Mixtral LLM**: Ollama at localhost:11434 (with fallback generation)
- **Stable Diffusion**: WebUI at 192.168.0.199:8001
- **Model**: cyberrealistic_v80.safetensors (preferred) or cyberrealisticPony_v8.safetensors
- **ADetailer Models**: face_yolov8n.pt, hand_yolov8n.pt, person_yolov8n-seg.pt, yolov8x-worldv2.pt, mediapipe_face_full, mediapipe_face_mesh, mediapipe_face_mesh_eyes_only
- **Roop Extension**: sd-webui-roop for face swapping (ultimate character consistency)
- **Face Sources**: in/individual/{name}/Images directory (ayushi, nitanshi)
- **Conda Environment**: ai-video-gen (recommended)

## Recent Major Fixes (July 2025)

### 1. Story Sequence Coherence ✅
**Problem**: 3rd image generated was "something out the world" - breaking narrative flow
**Solution**: 
- Updated `analyze_narrative_structure()` to require exactly 6 sequential frames
- Implemented story progression: Introduction → Initial action → Development → Peak moment → Resolution → Conclusion
- Added setting-specific story generators (park, street, mall, home, generic)
**Result**: All 6 frames now create coherent narrative progression

### 2. Character Consistency ✅
**Implementation**: 
- Character profile generation for visual consistency across frames
- Detailed character descriptions (appearance, clothing, features)
- Negative prompts to prevent character variations
- Single person constraint enforcement

### 3. Batch Generation with Face Analysis ✅
**Features**:
- 6 images generated per scene in 2 batches of 3
- MediaPipe and OpenCV face detection
- Quality scoring and realism checks
- Automatic selection of best image per scene
- Compatibility analysis across frames

### 4. ADetailer Integration ✅
**Models**: Automatic deformity fixing with multiple detection models
**Configuration**: Dynamic model detection and application

### 5. Character Consistency Enhancement ✅ (July 19, 2025)
**Problem**: Frames 4-6 breaking story continuity, inconsistent character appearance
**Solution**:
- Enhanced Mixtral prompts with explicit character consistency requirements
- Added clothing similarity analysis using computer vision
- Strengthened character profile enforcement with specific clothing/appearance details
- Updated image scoring to include clothing consistency (25% weight)
**Result**: Same character with identical clothing across all 6 frames

### 6. Clothing Similarity Analysis ✅ (July 19, 2025)
**Implementation**:
- Dominant color extraction using K-means clustering
- Color histogram comparison across frames
- Reference image comparison for visual consistency
- Integration into image selection scoring system
**Features**:
- Cross-frame clothing consistency scoring
- RGB color analysis and reporting
- Visual consistency indicators in UI (✅⚠️❌)

### 7. Roop Face Swapping Integration ✅ (July 19, 2025)
**Problem**: Even with character consistency, slight facial variations still occurred
**Solution**:
- Integrated Roop extension for 100% face consistency
- Random face selection from in/individual/{name}/Images directory
- Seed-based reproducible face selection using YmdH format
- Automatic Roop + ADetailer combination for maximum quality
**Implementation**:
- FaceSelector class for managing face images from multiple people
- Enhanced SD client with Roop API integration
- Batch face swapping with consistent seed variations
- Comprehensive face validation and error handling
**Result**: Achieves ultimate character consistency with exact same face across all 6 frames

## Technical Architecture

### Pipeline Flow
1. **Text Input** → Random test prompt if empty
2. **Face Selection** → Random face from in/individual/ directory (seed-based)
3. **Mixtral Analysis** → 6 coherent story frames (with fallback)
4. **Character Generation** → Consistent character profile
5. **Prompt Enhancement** → Scene-specific image prompts
6. **Roop Face Swapping** → Batch generation with selected face (if available)
7. **Face & Clothing Analysis** → Best image selection with consistency scoring
8. **Video Creation** → H.264 with transitions

### Output Structure
```
output/
├── frames/
│   ├── batch_scene_N/     # 6 candidate images per scene (with Roop face swap)
│   └── frame_NNN_*.png    # Selected final frames with consistent face
├── videos/
│   └── generated_video_*_h264.mp4
└── .gitkeep

in/
└── individual/
    ├── ayushi/            # Face images for ayushi
    │   └── image (N).png
    └── nitanshi/          # Face images for nitanshi
        └── image (N).png
```

### Seeds and Consistency
- **YmdH Format**: Base seed changes hourly for temporal consistency
- **Scene Seeds**: Base seed + scene number for variation within consistency
- **Face Selection**: Same base seed used for reproducible face selection
- **Character Profiles**: Shared across all scenes in a video
- **Roop Face Swapping**: Exact same face across all scenes when available

## Dependencies
- **Python**: gradio, opencv-python, pillow, numpy, requests, mediapipe, deepface, scikit-learn
- **External**: Ollama (Mixtral), Stable Diffusion WebUI, ffmpeg (optional)

## Usage
1. Start conda environment: `conda activate ai-video-gen`
2. Ensure SD WebUI running: `./webui.sh --api --port 8001`
3. Ensure Ollama/Mixtral running: `ollama serve` + `ollama run mixtral`
4. Run application: `python app.py`
5. Open browser: `http://localhost:8003`

## UI Features
- Text prompt input (with random test prompt generation)
- Progress tracking with detailed scene-by-scene updates
- Video output display
- Final selected frames gallery (6 frames, 3x2 layout)
- **Batch analysis display**: All 36 generated images with scores
- **Face & clothing analysis report**: Detailed breakdown per image
- **Consistency statistics**: Summary of face quality and clothing consistency
- Clean output folder button
- Sans-serif font styling

## Known Working Test Cases
- "woman walking in park" → 6-frame park story
- "woman wearing red walking park" → Character consistency maintained
- "man walking street" → Street scenario with navigation theme
- "woman shopping mall" → Shopping progression story

## Debug and Monitoring
- Comprehensive logging for all pipeline steps
- Batch image analysis with face detection results
- **Clothing consistency analysis with color breakdowns**
- Character profile generation and consistency tracking
- **Enhanced image scoring with face and clothing components**
- Video codec fallback system (H.264 → mp4v → XVID)
- **Real-time consistency scoring and ranking display**

## Future Considerations
- Video length customization (currently ~18 seconds for 6 frames)
- Additional transition types beyond fade/dissolve/cut
- Advanced character pose consistency
- Multiple character support (currently single person constraint)

---
Last Updated: July 19, 2025
Status: Production Ready
Recent Major Updates:
- Story sequence coherence (3rd frame narrative break) - RESOLVED
- Character consistency across all 6 frames - ENHANCED  
- Clothing similarity analysis system - IMPLEMENTED
- Batch image analysis UI with detailed scoring - ADDED
- Enhanced image selection with clothing consistency (25% weight) - ACTIVE
- Roop face swapping integration for ultimate consistency - IMPLEMENTED
- Random face selection from in/individual/ directory - ACTIVE
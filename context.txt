# AI Video Generation Project - Current Context

## Project Overview
4-step AI video generation pipeline that converts text prompts into coherent video stories:
1. Text prompt analysis (Mixtral LLM)
2. Scene sequence planning (6 coherent frames) 
3. Image generation (Stable Diffusion WebUI + batch generation + face analysis)
4. Video creation with transitions (H.264 encoding)

## Current Status: ‚úÖ FULLY FUNCTIONAL
- **Story Sequence Issue**: RESOLVED (3rd image breaking narrative flow)
- **Character Consistency**: ENHANCED (detailed character profiles + clothing analysis)
- **Clothing Consistency**: NEW (computer vision-based clothing similarity analysis)
- **Batch Generation**: ACTIVE (6 images per scene, face + clothing selection)
- **Video Output**: WORKING (H.264 encoded, browser-compatible)
- **UI Analysis Display**: ENHANCED (shows all 36 batch images with scores)

## Key Components

### Core Files
- `app.py` - Gradio web interface (port 8003)
- `video_generator.py` - Main pipeline orchestration
- `mixtral_client.py` - LLM integration for scene analysis and character consistency
- `sd_client.py` - Stable Diffusion WebUI API client with ADetailer integration
- `face_analyzer.py` - MediaPipe/OpenCV face detection, quality scoring, and clothing similarity analysis
- `face_selector.py` - Random face selection from in/individual/ directory for Roop face swapping

### Current Configuration
- **Mixtral LLM**: Ollama at localhost:11434 (with fallback generation)
- **Stable Diffusion**: WebUI at 192.168.0.199:8001
- **Model**: cyberrealistic_v80.safetensors (preferred) or cyberrealisticPony_v8.safetensors
- **ADetailer Models**: face_yolov8n.pt, hand_yolov8n.pt, person_yolov8n-seg.pt, yolov8x-worldv2.pt, mediapipe_face_full, mediapipe_face_mesh, mediapipe_face_mesh_eyes_only
- **Roop Extension**: sd-webui-roop for face swapping (ultimate character consistency)
- **Face Sources**: in/individual/{name}/Images directory (ayushi, nitanshi)
- **Conda Environment**: ai-video-gen (recommended)

## Recent Major Fixes (July 2025)

### 1. Story Sequence Coherence ‚úÖ
**Problem**: 3rd image generated was "something out the world" - breaking narrative flow
**Solution**: 
- Updated `analyze_narrative_structure()` to require exactly 6 sequential frames
- Implemented story progression: Introduction ‚Üí Initial action ‚Üí Development ‚Üí Peak moment ‚Üí Resolution ‚Üí Conclusion
- Added setting-specific story generators (park, street, mall, home, generic)
**Result**: All 6 frames now create coherent narrative progression

### 2. Character Consistency ‚úÖ
**Implementation**: 
- Character profile generation for visual consistency across frames
- Detailed character descriptions (appearance, clothing, features)
- Negative prompts to prevent character variations
- Single person constraint enforcement

### 3. Batch Generation with Face Analysis ‚úÖ
**Features**:
- 6 images generated per scene in 2 batches of 3
- MediaPipe and OpenCV face detection
- Quality scoring and realism checks
- Automatic selection of best image per scene
- Compatibility analysis across frames

### 4. ADetailer Integration ‚úÖ
**Models**: Automatic deformity fixing with multiple detection models
**Configuration**: Dynamic model detection and application

### 5. Character Consistency Enhancement ‚úÖ (July 19, 2025)
**Problem**: Frames 4-6 breaking story continuity, inconsistent character appearance
**Solution**:
- Enhanced Mixtral prompts with explicit character consistency requirements
- Added clothing similarity analysis using computer vision
- Strengthened character profile enforcement with specific clothing/appearance details
- Updated image scoring to include clothing consistency (25% weight)
**Result**: Same character with identical clothing across all 6 frames

### 6. Clothing Similarity Analysis ‚úÖ (July 19, 2025)
**Implementation**:
- Dominant color extraction using K-means clustering
- Color histogram comparison across frames
- Reference image comparison for visual consistency
- Integration into image selection scoring system
**Features**:
- Cross-frame clothing consistency scoring
- RGB color analysis and reporting
- Visual consistency indicators in UI (‚úÖ‚ö†Ô∏è‚ùå)

### 7. Roop Face Swapping Integration ‚úÖ (July 19, 2025)
**Problem**: Even with character consistency, slight facial variations still occurred
**Solution**:
- Integrated Roop extension for 100% face consistency
- Random face selection from in/individual/{name}/Images directory
- Seed-based reproducible face selection using YmdH format
- Automatic Roop + ADetailer combination for maximum quality
**Implementation**:
- FaceSelector class for managing face images from multiple people
- Enhanced SD client with Roop API integration
- Batch face swapping with consistent seed variations
- Comprehensive face validation and error handling
**Result**: Achieves ultimate character consistency with exact same face across all 6 frames

## Testing Framework üß™

### Comprehensive Test Suite (74 Tests)
- **test_imports.py** - Package and dependency validation
- **test_models.py** - Unit tests for all model classes
- **test_extensions.py** - SD WebUI, Roop, ADetailer, Ollama integration tests
- **test_directories.py** - File system structure and permissions
- **test_pipeline.py** - Functional tests for pipeline components
- **test_ui_components.py** - Gradio interface and styling tests

### Test Execution
- **Automatic**: Run via `./run.sh` (tests before app launch)
- **Manual**: Run via `python test_runner.py`
- **Options**: `--skip-tests`, `--force`, `--help`
- **Coverage**: 57 passed, 17 failed/errors (external dependencies), 2 skipped

## Technical Architecture

### Pipeline Flow
1. **Text Input** ‚Üí Random test prompt if empty
2. **Face Selection** ‚Üí Random face from in/individual/ directory (seed-based)
3. **Mixtral Analysis** ‚Üí 6 coherent story frames (with fallback, 100s timeout)
4. **Character Generation** ‚Üí Consistent character profile
5. **Prompt Enhancement** ‚Üí Scene-specific image prompts
6. **Roop Face Swapping** ‚Üí Batch generation with selected face (with error handling)
7. **Face & Clothing Analysis** ‚Üí Best image selection with consistency scoring
8. **Video Creation** ‚Üí H.264 with transitions (avc1 codec for compatibility)

### Output Structure
```
output/
‚îú‚îÄ‚îÄ frames/
‚îÇ   ‚îú‚îÄ‚îÄ batch_scene_N/     # 6 candidate images per scene (with Roop face swap)
‚îÇ   ‚îî‚îÄ‚îÄ frame_NNN_*.png    # Selected final frames with consistent face
‚îú‚îÄ‚îÄ videos/
‚îÇ   ‚îî‚îÄ‚îÄ generated_video_*_h264.mp4
‚îî‚îÄ‚îÄ .gitkeep

in/
‚îî‚îÄ‚îÄ individual/
    ‚îú‚îÄ‚îÄ ayushi/            # Face images for ayushi
    ‚îÇ   ‚îî‚îÄ‚îÄ image (N).png
    ‚îî‚îÄ‚îÄ nitanshi/          # Face images for nitanshi
        ‚îî‚îÄ‚îÄ image (N).png
```

### Seeds and Consistency
- **YmdH Format**: Base seed changes hourly for temporal consistency
- **Scene Seeds**: Base seed + scene number for variation within consistency
- **Face Selection**: Same base seed used for reproducible face selection
- **Character Profiles**: Shared across all scenes in a video
- **Roop Face Swapping**: Exact same face across all scenes when available

## Dependencies
- **Python**: gradio, opencv-python, pillow, numpy, requests, mediapipe, deepface, scikit-learn
- **External**: Ollama (Mixtral), Stable Diffusion WebUI, ffmpeg (optional)

## Usage
1. Start conda environment: `conda activate ai-video-gen`
2. Ensure SD WebUI running: `./webui.sh --api --port 8001`
3. Ensure Ollama/Mixtral running: `ollama serve` + `ollama run mixtral`
4. Run application: `python app.py`
5. Open browser: `http://localhost:8003`

## UI Features
- Text prompt input (with random test prompt generation)
- **Candidate count input**: Configurable images per scene (default: 2, range: 1-10)
- **Auto-clean checkbox**: Clean output frames before generation
- Progress tracking with detailed scene-by-scene updates
- Video output display
- Final selected frames gallery (6 frames, 3x2 layout)
- **Interactive comparison table**: Clickable thumbnails with scores and rankings
- **Batch analysis display**: All generated images with scores  
- **Face & clothing analysis report**: Detailed breakdown per image
- **Consistency statistics**: Summary of face quality and clothing consistency
- Clean output folder button
- Sans-serif font styling with improved contrast (dark text on light rank backgrounds)

## Known Working Test Cases
- "woman walking in park" ‚Üí 6-frame park story
- "woman wearing red walking park" ‚Üí Character consistency maintained
- "man walking street" ‚Üí Street scenario with navigation theme
- "woman shopping mall" ‚Üí Shopping progression story

## Debug and Monitoring
- Comprehensive logging for all pipeline steps
- Batch image analysis with face detection results
- **Clothing consistency analysis with color breakdowns**
- Character profile generation and consistency tracking
- **Enhanced image scoring with face and clothing components**
- Video codec fallback system (H.264 ‚Üí mp4v ‚Üí XVID)
- **Real-time consistency scoring and ranking display**

## Future Considerations
- Video length customization (currently ~18 seconds for 6 frames)
- Additional transition types beyond fade/dissolve/cut
- Advanced character pose consistency
- Multiple character support (currently single person constraint)

## Git Workflow and Version Control
**IMPORTANT**: Regular git commits are essential for tracking progress and maintaining code history. All significant changes should be committed with descriptive messages following the established pattern.

### Git Commit Guidelines
- Commit frequently after implementing features or fixes
- Use descriptive commit messages explaining the "why" not just the "what"
- Include üß™ Generated with [Claude Code](https://claude.ai/code) and Co-Authored-By tags
- Update context.txt with major changes before committing

---
Last Updated: July 19, 2025
Status: Production Ready with Comprehensive Testing
Recent Major Updates (Latest Session):
- **Comprehensive Testing Framework** - ADDED (74 tests covering all components)
- **UI Control Enhancements** - ADDED (candidate count input, auto-cleanup checkbox)
- **Roop Error Handling** - ENHANCED (automatic fallback to regular generation)
- **Mixtral Timeout** - INCREASED (30s ‚Üí 100s for complex prompts)
- **Video Codec Optimization** - IMPROVED (avc1 tag for better MP4 compatibility)
- **Table CSS Contrast** - FIXED (dark text on light backgrounds for readability)
- **Enhanced run.sh** - UPDATED (integrated testing with command-line options)

Previous Updates:
- Story sequence coherence (3rd frame narrative break) - RESOLVED
- Character consistency across all 6 frames - ENHANCED  
- Clothing similarity analysis system - IMPLEMENTED
- Batch image analysis UI with detailed scoring - ADDED
- Enhanced image selection with clothing consistency (25% weight) - ACTIVE
- Roop face swapping integration for ultimate consistency - IMPLEMENTED
- Random face selection from in/individual/ directory - ACTIVE